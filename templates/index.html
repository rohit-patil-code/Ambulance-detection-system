<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawaii Ambulance Detection System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
    <style>
        

        .traffic-light {
            width: 100px;
            height: 250px;
            background-color: black;
            border-radius: 20px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }

        .circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: gray; /* Default */
        }

        .circle.green {
            background-color: green;
        }

        .circle.red {
            background-color: red;
        }
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #fff5f7;
            background-image: url('https://images.unsplash.com/photo-1624160719183-b3b9566e3e79?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8aGVsbG8ta2l0dHl8fHx8fHwxNzAwODUwMDM5&ixlib=rb-4.0.3&q=80&utm_campaign=api-credit&utm_medium=referral&utm_source=unsplash_source&w=1080');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 15px;
            border: 4px solid #ffd1dc;
        }
        .traffic-light {
            width: 80px;
            height: 200px;
            background-color: #ffd1dc;
            border-radius: 20px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border: 4px solid #ffd1dc;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }
        .light {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ffd1dc;
            border: 3px solid #ffd1dc;
            transition: all 0.3s ease;
        }
        .red.active { background-color: #ff4d6d; }
        .yellow.active { background-color: #fffacd; }
        .green.active { background-color: #98ff98; }
        #webcam {
            transform: scaleX(-1);
            border-radius: 20px;
            border: 4px solid #ff69b4;
        }
        .kawaii-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            border: 4px solid #ff69b4;
        }
        .kawaii-button {
            background-color: #ff69b4;
            transition: all 0.3s ease;
            border: 3px solid #ff69b4;
        }
        .kawaii-button:hover {
            background-color: #ff69b4;
            transform: scale(1.05);
        }
        .custom-marker {
            background-color: #ff69b4;
            border-radius: 50%;
            border: 2px solid white;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="container mx-auto p-4">
        <h1 class="text-4xl font-bold text-pink-600 mb-6 text-center">
            üöë Kawaii Ambulance Detection System üö®
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="kawaii-container p-6">
                <h2 class="text-2xl font-bold text-pink-500 mb-4">üìπ Live Camera Feed</h2>
                <div class="relative">
                    <video id="webcam" class="w-full shadow-lg" autoplay playsinline></video>
                    <canvas id="detection-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                </div>

                <div class="mt-4 text-center">
                    <button id="startButton" class="kawaii-button invisible text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg">
                        Start Detection
                    </button>
                    <button 
    onclick="navigateToNearestHospital()" 
    class="kawaii-button text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg mt-4">
    Navigate to Nearest Hospital
</button>

                    
                </div>
                
            </div>

            <div class="kawaii-container p-6">
                
                <h2 class="text-2xl font-bold text-pink-500 mb-4">üó∫ Nearby Hospitals & Traffic Signals</h2>
                <div id="map" class="mb-6"></div>
                
                <div class="flex">
                    <div>
                        <h3 class="text-center mb-2 font-bold text-pink-400">Traffic Signal Status</h3>
                        <div class="traffic-light">
                            <div id="red-light" class="circle red"></div>
                            <div id="green-light" class="circle"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-pink-500 mb-2">üìù Detection Log</h3>
                    <div id="detectionLog" class="bg-pink-50 p-4 rounded-lg h-40 overflow-y-auto border-2 border-pink-200">
                    </div>
                    </div>
                    
                </div>
                
            </div>
        </div>
    </div>

    <script>
        let map, userMarker, hospitalMarkers = [], trafficSignalMarkers = [], routeLine;
        let model;
        let isDetecting = false;
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('detection-canvas');
        const ctx = canvas.getContext('2d');
        const redLight = document.getElementById('red-light');
        const greenLight = document.getElementById('green-light');
         const startButton = document.getElementById('startButton');
        const detectionLog = document.getElementById('detectionLog');
        const trafficLight=document.querySelector('.traffic-light');

        // // Initialize map
        // function initMap() {
        //     map = L.map('map').setView([0, 0], 13);
        //     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //         attribution: '¬© OpenStreetMap contributors'
        //     }).addTo(map);

        //     // Get user's location
        //     if (navigator.geolocation) {
        //         navigator.geolocation.getCurrentPosition(position => {
        //             const { latitude, longitude } = position.coords;
        //             map.setView([latitude, longitude], 15);
                    
        //             // Add user marker
        //             userMarker = L.marker([latitude, longitude]).addTo(map)
        //                 .bindPopup('Your Location')
        //                 .openPopup();

        //             // Add sample hospitals
        //             const hospitals = [
        //                 { lat: latitude + 0.01, lng: longitude + 0.01, name: "City Hospital" },
        //                 { lat: latitude - 0.01, lng: longitude - 0.01, name: "General Hospital" }
        //             ];

        //             // Add sample traffic signals
        //             const trafficSignals = [
        //                 { lat: latitude + 0.005, lng: longitude + 0.005 },
        //                 { lat: latitude - 0.005, lng: longitude - 0.005 }
        //             ];

        //             hospitals.forEach(hospital => {
        //                 const marker = L.marker([hospital.lat, hospital.lng])
        //                     .bindPopup(hospital.name)
        //                     .addTo(map);
        //                 hospitalMarkers.push(marker);
        //             });

        //             trafficSignals.forEach(signal => {
        //                 const marker = L.circle([signal.lat, signal.lng], {
        //                     color: 'red',
        //                     fillColor: '#f03',
        //                     fillOpacity: 0.5,
        //                     radius: 50
        //                 }).addTo(map);
        //                 trafficSignalMarkers.push(marker);
        //             });
        //         });
        //     }
        // }
      

        let directionsService, directionsRenderer;

function initMap() {
    // Initialize the map
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
    });

    // Initialize directions services
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    // Get user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;

            // Set map center to user's location
            const userLocation = { lat: latitude, lng: longitude };
            map.setCenter(userLocation);

            // Add custom user marker
            userMarker = new google.maps.Marker({
                position: userLocation,
                map,
                title: "Your Location",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png", // Custom pin
                },
            });

            // Use text-based search for "hospitals near me"
            const service = new google.maps.places.PlacesService(map);
            const request = {
                location: userLocation,
                radius: 5000, // 5 km radius
                query: "hospitals near me", // Specific query to filter only hospitals
            };

            service.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.forEach(place => {
                        if (place.business_status === "OPERATIONAL") { // Ensure hospital is operational
                            const marker = new google.maps.Marker({
                                position: place.geometry.location,
                                map,
                                title: place.name,
                            });

                            // Add info window and navigation button
                            const infoWindow = new google.maps.InfoWindow({
                                content: `<h4>${place.name}</h4><p>${place.formatted_address}</p>
                                          <button onclick="startNavigation(${latitude}, ${longitude}, ${place.geometry.location.lat()}, ${place.geometry.location.lng()})">
                                              Navigate Here
                                          </button>`,
                            });

                            marker.addListener("click", () => {
                                infoWindow.open(map, marker);
                            });
                        }
                    });
                } else {
                    console.error("Text Search failed:", status);
                }
            });
        });
    } else {
        alert("Geolocation is not supported by your browser.");
    }
}

// Function to start navigation
function startNavigation(startLat, startLng, destLat, destLng) {
    const start = { lat: startLat, lng: startLng };
    const destination = { lat: destLat, lng: destLng };

    const request = {
        origin: start,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING, // Change to WALKING, BICYCLING, or TRANSIT if needed
    };

    directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
        } else {
            console.error("Directions request failed:", status);
        }
    });
}

// Initialize the map on page load
window.onload = initMap;

// Initialize the map on page load
window.onload = initMap;
        async function setupWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
            } catch (error) {
                console.error('Error accessing webcam:', error);
                addToLog('Error: Cannot access webcam üò¢');
            }
        }

        async function loadModel() {
            try {
                model = await cocoSsd.load();
                startButton.disabled = false;
                addToLog('Model loaded successfully! üéâ');
            } catch (error) {
                console.error('Error loading model:', error);
                addToLog('Error: Failed to load detection model üò¢');
            }
        }

        function updateTrafficSignals(detected) {
            trafficSignalMarkers.forEach(marker => {
                marker.setStyle({
                    color: detected ? 'green' : 'red',
                    fillColor: detected ? '#0f3' : '#f03'
                });
            });
        }

        function findNearestHospital() {
            if (!userMarker) return null;
            const userLatLng = userMarker.getLatLng();
            let nearest = null;
            let minDist = Infinity;

            hospitalMarkers.forEach(marker => {
                const dist = userLatLng.distanceTo(marker.getLatLng());
                if (dist < minDist) {
                    minDist = dist;
                    nearest = marker;
                }
            });

            return nearest;
        }

        function drawRoute(hospital) {
            if (routeLine) {
                map.removeLayer(routeLine);
            }

            const userLatLng = userMarker.getLatLng();
            const hospitalLatLng = hospital.getLatLng();

            routeLine = L.polyline([
                [userLatLng.lat, userLatLng.lng],
                [hospitalLatLng.lat, hospitalLatLng.lng]
            ], {
                color: 'blue',
                weight: 3,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
        }

        async function detect() {
            if (!isDetecting) return;

            try {
                const predictions = await model.detect(video);
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let ambulanceDetected = false;
                predictions.forEach(prediction => {
                    if (prediction.class === 'car' && prediction.score > 0.5) {
                        ambulanceDetected = true;
                        
                        ctx.strokeStyle = '#ff69b4';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(
                            prediction.bbox[0], prediction.bbox[1],
                            prediction.bbox[2], prediction.bbox[3]
                        );

                        ctx.fillStyle = '#ff69b4';
                        ctx.font = '16px Quicksand';
                        ctx.fillText(
                            'üöë Potential Ambulance: ' + Math.round(prediction.score * 100) + '%',
                            prediction.bbox[0],
                            prediction.bbox[1] > 10 ? prediction.bbox[1] - 5 : 10
                        );
                    }
                });

                if (ambulanceDetected) {
                    handleAmbulanceDetection();
                }
            } catch (error) {
                console.error('Detection error:', error);
            }

            requestAnimationFrame(detect);
        }

        function handleAmbulanceDetection() {
            addToLog('üö® Ambulance detected! Making way... üö¶');
            const lights = trafficLight.children;
            Array.from(lights).forEach(l => l.classList.remove('active'));
            lights[2].classList.add('active');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    findNearbyHospitals(latitude, longitude);
                });
            }

            setTimeout(() => {
                Array.from(lights).forEach(l => l.classList.remove('active'));
                lights[0].classList.add('active');
            }, 5000);
        }
//         function navigateToNearestHospital() {
//             if (navigator.geolocation) {
//                     navigator.geolocation.getCurrentPosition(position => {
//                         const { latitude, longitude } = position.coords;
//                         const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=hospital+near+me&travelmode=driving`;
//                         window.open(googleMapsUrl, '_blank');
//                     }, () => {
//                     alert('Unable to retrieve your location.');
//                     });
//             } else {
//             alert('Geolocation is not supported by your browser.');
//     }
// }
function navigateToNearestHospital() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${latitude},${longitude}&destination=hospital+near+me&travelmode=driving`;

            // Use a timeout to delay the new tab opening, ensuring focus stays
            setTimeout(() => {
                const newTab = window.open(googleMapsUrl, '_blank', 'noopener,noreferrer');
                if (newTab) {
                    newTab.blur(); // Blur the new tab
                }
                window.focus(); // Refocus on the current tab
            }, 500); // Delay opening by 500ms
        }, () => {
            alert('Unable to retrieve your location.');
        });
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}



        async function pollTrafficLight() {
            try {
                // Fetch the status from the backend
                // const response = await fetch('/detect');
                const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convert frame to Blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

    // Send frame to Flask server for detection
    const formData = new FormData();
    formData.append('image', blob);

                const response = await fetch('/detect', {
            method: 'POST',
            body: formData,
        });
                console.log(response);
                const data = await response.json();

                // Update the traffic light colors
                if (data.status === "green") {
                    redLight.classList.remove('red');
                    greenLight.classList.add('green');
                    // navigateToNearestHospital();
                } else {
                    greenLight.classList.remove('green');
                    redLight.classList.add('red');
                }
            } catch (error) {
                console.error("Error fetching traffic light status:", error);
            }
        }

        // Poll the backend every 2 seconds
        setInterval(pollTrafficLight, 2000);


        function addToLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'text-sm text-pink-600 mb-1 font-medium';
            logEntry.textContent = `${timestamp}: ${message}`;


            detectionLog.insertBefore(logEntry, detectionLog.firstChild);
        }

        startButton.addEventListener('click', () => {
            if (!isDetecting) {
                isDetecting = true;
                startButton.textContent = 'Stop Detection';
                startButton.style.backgroundColor = '#ff1493';
                detect();
                addToLog('Detection started! üé•');
            } else {
                isDetecting = false;
                startButton.textContent = 'Start Detection';
                startButton.style.backgroundColor = '#ff69b4';
                addToLog('Detection stopped ‚èπ');
            }
        });

        async function init() {
            initMap();
            await setupWebcam();
            await loadModel();
            addToLog('System ready! Let\'s detect some ambulances! üöë‚ú®');
        }
        
        async function detectAmbulance() {
    // Capture frame from the webcam
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convert frame to Blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

    // Send frame to Flask server for detection
    const formData = new FormData();
    formData.append('image', blob);

    try {
        const response = await fetch('/detect', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();
        const detected = data.status === "green";

        // Update traffic signals based on detection
        updateTrafficSignals(detected);
        addToLog(detected ? 'üöë Ambulance detected! Turning light green.' : 'üö¶ No ambulance detected.');
    } catch (error) {
        console.error('Detection error:', error);
        addToLog('Detection error üò¢');
    }
}

// Poll for detection every 2 seconds
setInterval(detectAmbulance, 2000);

        init();
    </script>
</body>
</html>